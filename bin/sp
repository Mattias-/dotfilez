#!/bin/bash
set -euo pipefail

main() {
    track_url=$(get_track_url)
    track_json=$(get_track_json "$track_url")
    local cmd=""
    if [[ "$#" == 1 ]]; then
        cmd=$1
        shift
    fi

    if [[ "$cmd" == "eval" ]]; then
        cmd_eval "$track_json"
    else
        echo "$track_json"
    fi
}

get_track_url() {
    dbus-send --print-reply \
        --dest=org.mpris.MediaPlayer2.spotify \
        /org/mpris/MediaPlayer2 \
        org.freedesktop.DBus.Properties.Get \
        string:'org.mpris.MediaPlayer2.Player' \
        string:'Metadata' |
        grep -o 'https[^"]*'
    # Look for a string that starts with `https`
}

get_track_json() {
    track_url=$1
    curl -s "$track_url" |
        grep -oP 'Spotify.Entity = \K([^;]+)'
    # Get everything between `Spotify.Entity = ` and `;`
}

cmd_eval() {
    # Print variables that can be evaluated by bash
    local track_json=$1
    title=$(jq '.name' <<<"$track_json")
    artists=$(jq '[.artists[].name] | join(", ")' <<<"$track_json")
    echo "SPOTIFY_TITLE=$title"
    echo "SPOTIFY_ARTIST=$artists"
}

main "$@"
